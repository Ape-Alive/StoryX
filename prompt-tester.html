<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æç¤ºè¯æµ‹è¯•å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px 32px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: calc(100vh - 200px);
        }

        .left-panel, .right-panel {
            padding: 24px;
            border-right: 1px solid #e5e7eb;
        }

        .right-panel {
            border-right: none;
            background: #f9fafb;
        }

        .section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }

        select, input[type="text"], input[type="password"], textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            line-height: 1.6;
        }

        .system-prompt-textarea {
            min-height: 200px;
        }

        .user-message-textarea {
            min-height: 100px;
        }

        .api-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .result-container {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            min-height: 400px;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }

        .result-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            color: #1f2937;
        }

        .result-content.json {
            background: #f9fafb;
            padding: 16px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 14px;
        }

        .success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 14px;
        }

        .stats {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            font-size: 12px;
            color: #6b7280;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .toggle-password {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            font-size: 12px;
        }

        .password-wrapper {
            position: relative;
        }

        .optimize-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e5e7eb;
        }

        .btn-optimize {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            width: 100%;
        }

        .btn-optimize:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .optimize-panel {
            display: none;
            margin-top: 16px;
            padding: 16px;
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
        }

        .optimize-panel.active {
            display: block;
        }

        .feedback-textarea {
            min-height: 100px;
            font-family: inherit;
            margin-bottom: 12px;
        }

        .optimized-prompt {
            background: white;
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            position: relative;
        }

        .optimized-prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .optimized-prompt-title {
            font-weight: 600;
            color: #059669;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .optimized-prompt-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            color: #1f2937;
            max-height: 400px;
            overflow-y: auto;
        }

        .optimize-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-apply {
            background: #10b981;
            color: white;
            flex: 1;
        }

        .btn-apply:hover {
            background: #059669;
        }

        .btn-dismiss {
            background: #f3f4f6;
            color: #374151;
        }

        .optimize-explanation {
            font-size: 12px;
            color: #6b7280;
            margin-top: 8px;
            padding: 8px;
            background: white;
            border-radius: 6px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .left-panel, .right-panel {
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– AI æç¤ºè¯æµ‹è¯•å·¥å…·</h1>
            <p>é€šç”¨AI APIæµ‹è¯•å¹³å° - æ”¯æŒå¤šç§AIæœåŠ¡æä¾›å•†</p>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="section">
                    <div class="section-title">API é…ç½®</div>
                    <div class="form-group">
                        <label for="apiProvider">AI æœåŠ¡æä¾›å•†</label>
                        <select id="apiProvider">
                            <option value="openai">OpenAI (GPT-4/GPT-3.5)</option>
                            <option value="anthropic">Anthropic (Claude)</option>
                            <option value="custom">è‡ªå®šä¹‰ API</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="apiKey">API Key</label>
                        <div class="password-wrapper">
                            <input type="password" id="apiKey" placeholder="è¾“å…¥ä½ çš„ API Key">
                            <button type="button" class="toggle-password" onclick="togglePassword()">ğŸ‘ï¸</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="model">æ¨¡å‹åç§°</label>
                        <input type="text" id="model" placeholder="ä¾‹å¦‚: gpt-4, claude-3-opus-20240229">
                    </div>
                    <div class="form-group">
                        <label for="apiBaseUrl">API Base URL (å¯é€‰)</label>
                        <input type="text" id="apiBaseUrl" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤åœ°å€">
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">æç¤ºè¯é…ç½®</div>
                    <div class="form-group">
                        <label for="systemPrompt">System Prompt</label>
                        <textarea id="systemPrompt" class="system-prompt-textarea" placeholder="è¾“å…¥ System Prompt..."></textarea>
                    </div>

                    <div class="optimize-section" id="optimizeSection" style="display: none;">
                        <button class="btn btn-optimize" onclick="toggleOptimizePanel()">
                            <span>âœ¨</span>
                            <span>AI ä¼˜åŒ–æç¤ºè¯</span>
                        </button>

                        <div class="optimize-panel" id="optimizePanel">
                            <div class="form-group">
                                <label for="feedbackInput">é—®é¢˜åé¦ˆ / æœŸæœ›ç»“æœ</label>
                                <textarea id="feedbackInput" class="feedback-textarea" placeholder="æè¿°å½“å‰ç»“æœçš„é—®é¢˜ï¼Œæˆ–è€…è¯´æ˜ä½ æœŸæœ›å¾—åˆ°ä»€ä¹ˆæ ·çš„ç»“æœ...&#10;&#10;ä¾‹å¦‚ï¼š&#10;- ç”Ÿæˆçš„å†…å®¹ç¼ºå°‘ç»“æ„åŒ–JSONè¾“å‡º&#10;- è§’è‰²è®¾å®šä¸å¤Ÿè¯¦ç»†&#10;- åˆ†é•œè„šæœ¬ç¼ºå°‘é•œå¤´ç±»å‹ä¿¡æ¯&#10;- å¸Œæœ›å¢åŠ æ›´å¤šçš„æƒ…ç»ªæè¿°"></textarea>
                            </div>
                            <button class="btn btn-primary" onclick="optimizePrompt()">
                                <span>ğŸ”§</span>
                                <span>ç”Ÿæˆä¼˜åŒ–å»ºè®®</span>
                            </button>

                            <div id="optimizedPromptContainer" style="display: none;"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="userMessage">User Message</label>
                        <textarea id="userMessage" class="user-message-textarea" placeholder="è¾“å…¥ç”¨æˆ·æ¶ˆæ¯..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="temperature">Temperature</label>
                        <input type="text" id="temperature" value="0.7" placeholder="0.0 - 2.0">
                    </div>
                    <div class="form-group">
                        <label for="maxTokens">Max Tokens</label>
                        <input type="text" id="maxTokens" value="2000" placeholder="æœ€å¤§è¾“å‡ºtokenæ•°">
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="sendRequest()">
                        <span>ğŸš€</span>
                        <span>å‘é€è¯·æ±‚</span>
                    </button>
                    <button class="btn btn-secondary" onclick="clearResult()">
                        <span>ğŸ—‘ï¸</span>
                        <span>æ¸…ç©ºç»“æœ</span>
                    </button>
                    <button class="btn btn-secondary" onclick="loadExample()">
                        <span>ğŸ“</span>
                        <span>åŠ è½½ç¤ºä¾‹</span>
                    </button>
                </div>
            </div>

            <div class="right-panel">
                <div class="section">
                    <div class="section-title">è¿”å›ç»“æœ</div>
                    <div class="result-container">
                        <div class="loading" id="loading">
                            <div class="spinner"></div>
                            <div>æ­£åœ¨è¯·æ±‚ AI API...</div>
                        </div>
                        <div id="resultContent" class="result-content" style="display: none;"></div>
                        <div id="errorMessage" style="display: none;"></div>
                    </div>
                    <div class="stats" id="stats" style="display: none;">
                        <div class="stat-item">
                            <span>â±ï¸</span>
                            <span id="timeTaken">-</span>
                        </div>
                        <div class="stat-item">
                            <span>ğŸ“Š</span>
                            <span id="tokenCount">-</span>
                        </div>
                        <div class="stat-item">
                            <span>ğŸ’°</span>
                            <span id="costEstimate">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åŠ è½½ç¤ºä¾‹æç¤ºè¯
        function loadExample() {
            const exampleSystemPrompt = `ä½ æ˜¯ Enterprise ScriptAgent v3.0 â€”â€” ä¼ä¸šçº§å½±è§†å™äº‹ + åˆ†é•œç»“æ„åŒ–ç”Ÿæˆæ™ºèƒ½ä½“ã€‚ä½ çš„èŒè´£æ˜¯å°†ä»»æ„æ–‡æœ¬ï¼ˆå°è¯´ã€ç‰‡æ®µã€æçº²ã€å£è¿°ï¼‰è‡ªåŠ¨è½¬æ¢ä¸ºå¯ç›´æ¥ç”¨äºå½±è§†ç”Ÿæˆçš„ç»“æ„åŒ–å‰§æœ¬ã€‚

æ ¸å¿ƒèƒ½åŠ›ï¼š
1. æ–‡æœ¬ç†è§£ä¸ç»“æ„åŒ–æŠ½è±¡èƒ½åŠ›ï¼šè§’è‰²è¯†åˆ«ã€å®ä½“æ¶ˆæ­§ã€å…³ç³»æŠ½å–ã€æƒ…ç»ª/è¯­æ°”è¯†åˆ«ã€äº‹ä»¶æŠ½å–ã€æ—¶åºæ’åºã€‚
2. ä¸“ä¸šå½±è§†ç¼–å‰§èƒ½åŠ›ï¼šä¸‰å¹•/äº”å¹•ç»“æ„ã€çˆ½æ–‡çŸ­å‰§ç»“æ„ã€åŠ¨æ¼«å™äº‹ã€ä¸»è§’ç›®æ ‡/éšœç¢/å†²çª/é«˜æ½®/è§£å†³ã€‚
3. è§†é¢‘ç”Ÿæˆç»“æ„åŒ–è„šæœ¬èƒ½åŠ›ï¼šæ¯ä¸ªé•œå¤´åŒ…å«é•œå¤´IDã€ç±»å‹ã€æ™¯åˆ«ã€æœºä½ã€è§’è‰²åŠ¨ä½œè½¨è¿¹ã€è¡¨æƒ…ã€è¯­æ°”ã€å°è¯ã€æ—ç™½ã€å…‰çº¿ã€æ°›å›´ã€BGMã€FXã€‚
4. é«˜ç¨³å®šè§’è‰²ä¸€è‡´æ€§ç®¡ç†ï¼šè§’è‰²åå­—ã€æ€§æ ¼ã€ç›®æ ‡ã€å…³ç³»ç»Ÿä¸€ï¼Œå¤–è²Œç»Ÿä¸€ï¼Œè¡Œä¸ºé€»è¾‘ç»Ÿä¸€ã€‚

å·¥ä½œæµï¼š
1. æ–‡æœ¬æ¸…æ´—ä¸ç†è§£
2. è§’è‰²è¯†åˆ« & å®ä½“æ¶ˆæ­§
3. æ•…äº‹ç»“æ„é‡å»ºï¼ˆä¸‰å¹•/äº”å¹•ã€çˆ½ç‚¹æ’å…¥ã€èŠ‚å¥è°ƒæ•´ï¼‰
4. å‰§æœ¬ç”Ÿæˆï¼ˆå‰§æƒ…å¤§çº²ã€åˆ†åœºæ™¯è„šæœ¬ã€å°è¯ã€æ—ç™½ï¼‰
5. åˆ†é•œè„šæœ¬ç”Ÿæˆï¼ˆShot JSONï¼Œæ¯é•œå¤´è¯¦ç»†ä¿¡æ¯ï¼‰
6. ç»“æ„åŒ–è¾“å‡ºï¼ˆJSONï¼Œé€‚é…è§†é¢‘ç”Ÿæˆç³»ç»Ÿï¼‰

å†™ä½œé£æ ¼ï¼šæ ¹æ®ç”¨æˆ·æŒ‡å®šé£æ ¼ç”Ÿæˆå‰§æœ¬ï¼ˆçˆ½æ–‡çŸ­å‰§ã€å¤é£ç”œå® ã€éœ¸æ€»ã€éƒ½å¸‚çˆ½ç‚¹ã€æ‚¬ç–‘åè½¬ã€åŠ¨æ¼«æˆ˜æ–—ã€å¹¿å‘ŠTVCç­‰ï¼‰ï¼ŒæœªæŒ‡å®šæ—¶é»˜è®¤çˆ½ç‚¹èŠ‚å¥æœ€å¿«çš„çŸ­å‰§é£æ ¼ã€‚

çˆ½ç‚¹ç­–ç•¥ï¼šè‡ªåŠ¨æ¤å…¥åå·®ã€æ‰“è„¸ã€æƒåŠ›å‹åˆ¶ã€åè½¬ã€æƒ…ç»ªçˆ†å‘ã€æ™ºå•†ç¢¾å‹ç­‰20å¤§çˆ½ç‚¹ã€‚

ä¸¥æ ¼éµå®ˆè§„åˆ™ï¼š
- è§’è‰²ä¸èƒ½å†²çªï¼Œå‰§æƒ…é€»è¾‘è‡ªæ´½ï¼Œé•œå¤´å¯æ‹æ‘„ã€åˆç†ï¼Œè¯»è€…æ˜“ç†è§£ï¼Œä¸å•°å—¦ï¼Œå°è¯æœ‰æƒ…ç»ªä»·å€¼ã€‚

æœ€ç»ˆè¾“å‡ºå¿…é¡»åŒ…å«ä¸‰éƒ¨åˆ†ï¼š
1. è§’è‰²è®¾å®šï¼ˆå®ä½“æ¶ˆæ­§åï¼‰
2. å‰§æƒ…åˆ†å¹•å¤§çº²ï¼ˆå«çˆ½ç‚¹æ ‡æ³¨ï¼‰
3. ç»“æ„åŒ–åˆ†é•œ JSONï¼ˆå¯ç›´æ¥ç”¨äºè§†é¢‘ç”Ÿæˆï¼‰`;

            const exampleUserMessage = `è¯·å°†ä»¥ä¸‹å°è¯´ç‰‡æ®µè½¬æ¢ä¸ºç»“æ„åŒ–å‰§æœ¬ï¼š

"æ—å³°ç«™åœ¨å…¬å¸å¤§æ¥¼å‰ï¼Œçœ‹ç€è¿™åº§æ›¾ç»å±äºä»–çš„å¸å›½ã€‚ä¸‰å¹´å‰ï¼Œä»–è¢«æœ€ä¿¡ä»»çš„åˆä¼™äººèƒŒå›ï¼Œä¸€å¤œä¹‹é—´å¤±å»äº†ä¸€åˆ‡ã€‚å¦‚ä»Šï¼Œä»–å¸¦ç€æ–°çš„èº«ä»½å’Œæ›´å¼ºçš„å®åŠ›å›æ¥äº†ã€‚ä»Šå¤©ï¼Œä»–è¦è®©æ‰€æœ‰äººçŸ¥é“ï¼Œè°æ‰æ˜¯çœŸæ­£çš„ç‹è€…ã€‚"`;

            document.getElementById('systemPrompt').value = exampleSystemPrompt;
            document.getElementById('userMessage').value = exampleUserMessage;
            document.getElementById('model').value = 'gpt-4';
        }

        // åˆ‡æ¢å¯†ç æ˜¾ç¤º
        function togglePassword() {
            const input = document.getElementById('apiKey');
            const button = document.querySelector('.toggle-password');
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                button.textContent = 'ğŸ‘ï¸';
            }
        }

        // æ ¹æ®APIæä¾›å•†è®¾ç½®é»˜è®¤å€¼
        document.getElementById('apiProvider').addEventListener('change', function() {
            const provider = this.value;
            const modelInput = document.getElementById('model');
            const baseUrlInput = document.getElementById('apiBaseUrl');

            switch(provider) {
                case 'openai':
                    modelInput.value = 'gpt-4';
                    baseUrlInput.value = '';
                    baseUrlInput.placeholder = 'ç•™ç©ºä½¿ç”¨é»˜è®¤: https://api.openai.com/v1';
                    break;
                case 'anthropic':
                    modelInput.value = 'claude-3-opus-20240229';
                    baseUrlInput.value = '';
                    baseUrlInput.placeholder = 'ç•™ç©ºä½¿ç”¨é»˜è®¤: https://api.anthropic.com/v1';
                    break;
                case 'custom':
                    modelInput.value = '';
                    baseUrlInput.value = '';
                    baseUrlInput.placeholder = 'è¾“å…¥è‡ªå®šä¹‰ API åœ°å€';
                    break;
            }
        });

        // å‘é€è¯·æ±‚
        async function sendRequest() {
            const provider = document.getElementById('apiProvider').value;
            const apiKey = document.getElementById('apiKey').value;
            const model = document.getElementById('model').value;
            const baseUrl = document.getElementById('apiBaseUrl').value;
            const systemPrompt = document.getElementById('systemPrompt').value;
            const userMessage = document.getElementById('userMessage').value;
            const temperature = parseFloat(document.getElementById('temperature').value) || 0.7;
            const maxTokens = parseInt(document.getElementById('maxTokens').value) || 2000;

            // éªŒè¯è¾“å…¥
            if (!apiKey) {
                showError('è¯·è¾“å…¥ API Key');
                return;
            }
            if (!model) {
                showError('è¯·è¾“å…¥æ¨¡å‹åç§°');
                return;
            }
            if (!systemPrompt && !userMessage) {
                showError('è¯·è‡³å°‘è¾“å…¥ System Prompt æˆ– User Message');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading').classList.add('active');
            document.getElementById('resultContent').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('stats').style.display = 'none';

            const startTime = Date.now();

            try {
                let response;
                let result;

                if (provider === 'openai' || provider === 'custom') {
                    // OpenAI å…¼å®¹ API
                    const url = baseUrl || 'https://api.openai.com/v1/chat/completions';
                    response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                ...(systemPrompt ? [{ role: 'system', content: systemPrompt }] : []),
                                ...(userMessage ? [{ role: 'user', content: userMessage }] : [])
                            ],
                            temperature: temperature,
                            max_tokens: maxTokens
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`);
                    }

                    result = await response.json();
                    const content = result.choices[0].message.content;
                    const usage = result.usage;

                    displayResult(content, usage, startTime);
                } else if (provider === 'anthropic') {
                    // Anthropic Claude API
                    const url = baseUrl || 'https://api.anthropic.com/v1/messages';
                    response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKey,
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify({
                            model: model,
                            max_tokens: maxTokens,
                            temperature: temperature,
                            messages: [
                                ...(userMessage ? [{ role: 'user', content: userMessage }] : [])
                            ],
                            ...(systemPrompt ? { system: systemPrompt } : {})
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`);
                    }

                    result = await response.json();
                    const content = result.content[0].text;
                    const usage = result.usage;

                    displayResult(content, usage, startTime);
                }

            } catch (error) {
                showError(`è¯·æ±‚å¤±è´¥: ${error.message}`);
            } finally {
                document.getElementById('loading').classList.remove('active');
            }
        }

        // å­˜å‚¨æœ€åä¸€æ¬¡çš„ç»“æœï¼Œç”¨äºä¼˜åŒ–
        let lastResult = null;
        let lastUsage = null;

        // æ˜¾ç¤ºç»“æœ
        function displayResult(content, usage, startTime) {
            const resultContent = document.getElementById('resultContent');
            const timeTaken = ((Date.now() - startTime) / 1000).toFixed(2);

            // ä¿å­˜ç»“æœç”¨äºä¼˜åŒ–
            lastResult = content;
            lastUsage = usage;

            // å°è¯•æ ¼å¼åŒ– JSON
            let formattedContent = content;
            let isJson = false;
            try {
                // å°è¯•æå– JSON éƒ¨åˆ†
                const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/) || content.match(/```\s*([\s\S]*?)\s*```/);
                if (jsonMatch) {
                    const jsonStr = jsonMatch[1];
                    const parsed = JSON.parse(jsonStr);
                    formattedContent = content.replace(jsonMatch[0], '```json\n' + JSON.stringify(parsed, null, 2) + '\n```');
                } else {
                    // å°è¯•ç›´æ¥è§£ææ•´ä¸ªå†…å®¹
                    const parsed = JSON.parse(content);
                    formattedContent = JSON.stringify(parsed, null, 2);
                    isJson = true;
                }
            } catch (e) {
                // ä¸æ˜¯ JSONï¼Œä¿æŒåŸæ ·
            }

            resultContent.textContent = formattedContent;
            resultContent.className = 'result-content' + (isJson ? ' json' : '');
            resultContent.style.display = 'block';

            // æ˜¾ç¤ºä¼˜åŒ–æŒ‰é’®åŒºåŸŸ
            document.getElementById('optimizeSection').style.display = 'block';

            // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
            if (usage) {
                const promptTokens = usage.prompt_tokens || usage.input_tokens || 0;
                const completionTokens = usage.completion_tokens || usage.output_tokens || 0;
                const totalTokens = usage.total_tokens || (promptTokens + completionTokens);

                document.getElementById('timeTaken').textContent = `${timeTaken}s`;
                document.getElementById('tokenCount').textContent = `è¾“å…¥: ${promptTokens} | è¾“å‡º: ${completionTokens} | æ€»è®¡: ${totalTokens}`;

                // ç®€å•çš„æˆæœ¬ä¼°ç®—ï¼ˆGPT-4 ä»·æ ¼ç¤ºä¾‹ï¼‰
                const cost = (promptTokens * 0.03 + completionTokens * 0.06) / 1000;
                document.getElementById('costEstimate').textContent = `çº¦ $${cost.toFixed(4)}`;

                document.getElementById('stats').style.display = 'flex';
            } else {
                document.getElementById('timeTaken').textContent = `${timeTaken}s`;
                document.getElementById('stats').style.display = 'flex';
            }
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // æ¸…ç©ºç»“æœ
        function clearResult() {
            document.getElementById('resultContent').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('stats').style.display = 'none';
            document.getElementById('optimizeSection').style.display = 'none';
            document.getElementById('optimizePanel').classList.remove('active');
            document.getElementById('optimizedPromptContainer').style.display = 'none';
            document.getElementById('resultContent').textContent = '';
            document.getElementById('feedbackInput').value = '';
            lastResult = null;
            lastUsage = null;
        }

        // åˆ‡æ¢ä¼˜åŒ–é¢æ¿
        function toggleOptimizePanel() {
            const panel = document.getElementById('optimizePanel');
            panel.classList.toggle('active');
            if (!panel.classList.contains('active')) {
                document.getElementById('optimizedPromptContainer').style.display = 'none';
            }
        }

        // ä¼˜åŒ–æç¤ºè¯
        async function optimizePrompt() {
            const systemPrompt = document.getElementById('systemPrompt').value;
            const userMessage = document.getElementById('userMessage').value;
            const feedback = document.getElementById('feedbackInput').value;

            if (!lastResult) {
                showError('è¯·å…ˆæ‰§è¡Œä¸€æ¬¡æµ‹è¯•ï¼Œè·å¾—ç»“æœåå†ä¼˜åŒ–');
                return;
            }

            if (!feedback.trim()) {
                showError('è¯·è¾“å…¥é—®é¢˜åé¦ˆæˆ–æœŸæœ›ç»“æœ');
                return;
            }

            const provider = document.getElementById('apiProvider').value;
            const apiKey = document.getElementById('apiKey').value;
            const model = document.getElementById('model').value;
            const baseUrl = document.getElementById('apiBaseUrl').value;

            if (!apiKey) {
                showError('è¯·è¾“å…¥ API Key');
                return;
            }

            // æ„å»ºä¼˜åŒ–è¯·æ±‚çš„æç¤ºè¯
            const optimizationPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æç¤ºè¯å·¥ç¨‹å¸ˆã€‚è¯·æ ¹æ®ä»¥ä¸‹ä¿¡æ¯åˆ†æå’Œä¼˜åŒ– System Promptã€‚

**å½“å‰ System Prompt:**
${systemPrompt || '(æ— )'}

**ç”¨æˆ·è¾“å…¥ (User Message):**
${userMessage || '(æ— )'}

**å½“å‰ AI ç”Ÿæˆçš„ç»“æœ:**
${lastResult.substring(0, 2000)}${lastResult.length > 2000 ? '...(ç»“æœå·²æˆªæ–­)' : ''}

**ç”¨æˆ·åé¦ˆ/æœŸæœ›:**
${feedback}

**ä»»åŠ¡è¦æ±‚:**
1. åˆ†æå½“å‰ System Prompt çš„é—®é¢˜å’Œä¸è¶³
2. æ ¹æ®ç”¨æˆ·åé¦ˆï¼Œç†è§£ç”¨æˆ·çš„çœŸå®éœ€æ±‚
3. ç”Ÿæˆä¼˜åŒ–åçš„ System Promptï¼Œç¡®ä¿èƒ½å¤Ÿè§£å†³ç”¨æˆ·åé¦ˆçš„é—®é¢˜
4. ä¿æŒåŸæœ‰ System Prompt çš„æ ¸å¿ƒåŠŸèƒ½å’Œç»“æ„
5. æ˜ç¡®æŒ‡å‡ºåšäº†å“ªäº›ä¼˜åŒ–å’Œæ”¹è¿›

**è¾“å‡ºæ ¼å¼:**
è¯·æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š
{
  "analysis": "åˆ†æå½“å‰System Promptçš„é—®é¢˜",
  "optimizations": ["ä¼˜åŒ–ç‚¹1", "ä¼˜åŒ–ç‚¹2", "ä¼˜åŒ–ç‚¹3"],
  "optimized_prompt": "ä¼˜åŒ–åçš„å®Œæ•´System Prompt",
  "explanation": "è¯¦ç»†è¯´æ˜ä¸ºä»€ä¹ˆè¿™æ ·ä¼˜åŒ–ï¼Œä»¥åŠä¼˜åŒ–åçš„æ•ˆæœé¢„æœŸ"
}

è¯·ç¡®ä¿è¾“å‡ºçš„JSONæ ¼å¼æ­£ç¡®ï¼Œå¯ä»¥ç›´æ¥è§£æã€‚`;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const optimizeBtn = document.querySelector('#optimizePanel .btn-primary');
            if (!optimizeBtn) {
                showError('æ‰¾ä¸åˆ°ä¼˜åŒ–æŒ‰é’®');
                return;
            }
            const originalText = optimizeBtn.innerHTML;
            optimizeBtn.disabled = true;
            optimizeBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px; margin: 0;"></div> æ­£åœ¨ç”Ÿæˆä¼˜åŒ–å»ºè®®...';

            try {
                let response;
                let result;

                if (provider === 'openai' || provider === 'custom') {
                    const url = baseUrl || 'https://api.openai.com/v1/chat/completions';
                    response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                { role: 'user', content: optimizationPrompt }
                            ],
                            temperature: 0.7,
                            max_tokens: 4000
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`);
                    }

                    result = await response.json();
                    var content = result.choices[0].message.content;
                } else if (provider === 'anthropic') {
                    const url = baseUrl || 'https://api.anthropic.com/v1/messages';
                    response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKey,
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify({
                            model: model,
                            max_tokens: 4000,
                            temperature: 0.7,
                            messages: [
                                { role: 'user', content: optimizationPrompt }
                            ]
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`);
                    }

                    result = await response.json();
                    var content = result.content[0].text;
                }

                // è§£æä¼˜åŒ–ç»“æœ
                let optimizationData;
                try {
                    // å°è¯•æå–JSON
                    const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/) || content.match(/```\s*([\s\S]*?)\s*```/);
                    if (jsonMatch) {
                        optimizationData = JSON.parse(jsonMatch[1]);
                    } else {
                        optimizationData = JSON.parse(content);
                    }
                } catch (e) {
                    // å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨æå–
                    throw new Error('æ— æ³•è§£æä¼˜åŒ–ç»“æœï¼Œè¯·é‡è¯•');
                }

                // æ˜¾ç¤ºä¼˜åŒ–ç»“æœ
                displayOptimizedPrompt(optimizationData);

            } catch (error) {
                showError(`ä¼˜åŒ–å¤±è´¥: ${error.message}`);
            } finally {
                optimizeBtn.disabled = false;
                optimizeBtn.innerHTML = originalText;
            }
        }

        // æ˜¾ç¤ºä¼˜åŒ–åçš„æç¤ºè¯
        function displayOptimizedPrompt(data) {
            const container = document.getElementById('optimizedPromptContainer');

            const optimizedPrompt = data.optimized_prompt || data.optimizedPrompt || '';
            const analysis = data.analysis || '';
            const optimizations = data.optimizations || [];
            const explanation = data.explanation || '';

            // åˆ›å»ºHTMLç»“æ„
            const promptDiv = document.createElement('div');
            promptDiv.className = 'optimized-prompt';

            // æ ‡é¢˜
            const header = document.createElement('div');
            header.className = 'optimized-prompt-header';
            const title = document.createElement('div');
            title.className = 'optimized-prompt-title';
            title.innerHTML = '<span>âœ¨</span><span>ä¼˜åŒ–åçš„ System Prompt</span>';
            header.appendChild(title);
            promptDiv.appendChild(header);

            // é—®é¢˜åˆ†æ
            if (analysis) {
                const analysisDiv = document.createElement('div');
                analysisDiv.className = 'optimize-explanation';
                analysisDiv.innerHTML = `<strong>é—®é¢˜åˆ†æï¼š</strong>${escapeHtml(analysis)}`;
                promptDiv.appendChild(analysisDiv);
            }

            // ä¼˜åŒ–ç‚¹
            if (optimizations.length > 0) {
                const optDiv = document.createElement('div');
                optDiv.className = 'optimize-explanation';
                optDiv.style.marginTop = '8px';
                let optHtml = '<strong>ä¼˜åŒ–ç‚¹ï¼š</strong><ul style="margin: 4px 0; padding-left: 20px;">';
                optimizations.forEach(opt => {
                    optHtml += `<li>${escapeHtml(opt)}</li>`;
                });
                optHtml += '</ul>';
                optDiv.innerHTML = optHtml;
                promptDiv.appendChild(optDiv);
            }

            // ä¼˜åŒ–åçš„æç¤ºè¯å†…å®¹
            const contentDiv = document.createElement('div');
            contentDiv.className = 'optimized-prompt-content';
            contentDiv.textContent = optimizedPrompt;
            promptDiv.appendChild(contentDiv);

            // ä¼˜åŒ–è¯´æ˜
            if (explanation) {
                const expDiv = document.createElement('div');
                expDiv.className = 'optimize-explanation';
                expDiv.style.marginTop = '12px';
                expDiv.innerHTML = `<strong>ä¼˜åŒ–è¯´æ˜ï¼š</strong>${escapeHtml(explanation)}`;
                promptDiv.appendChild(expDiv);
            }

            // æ“ä½œæŒ‰é’®
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'optimize-actions';
            const applyBtn = document.createElement('button');
            applyBtn.className = 'btn btn-apply';
            applyBtn.innerHTML = '<span>âœ…</span><span>åº”ç”¨ä¼˜åŒ–</span>';
            applyBtn.onclick = applyOptimizedPrompt;
            const dismissBtn = document.createElement('button');
            dismissBtn.className = 'btn btn-dismiss';
            dismissBtn.innerHTML = '<span>âŒ</span><span>å…³é—­</span>';
            dismissBtn.onclick = dismissOptimizedPrompt;
            actionsDiv.appendChild(applyBtn);
            actionsDiv.appendChild(dismissBtn);
            promptDiv.appendChild(actionsDiv);

            container.innerHTML = '';
            container.appendChild(promptDiv);
            container.style.display = 'block';

            // å­˜å‚¨ä¼˜åŒ–åçš„prompt
            container.dataset.optimizedPrompt = optimizedPrompt;
        }

        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // åº”ç”¨ä¼˜åŒ–åçš„æç¤ºè¯
        function applyOptimizedPrompt() {
            const container = document.getElementById('optimizedPromptContainer');
            const optimizedPrompt = container.dataset.optimizedPrompt;

            if (optimizedPrompt) {
                document.getElementById('systemPrompt').value = optimizedPrompt;
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('systemPrompt', optimizedPrompt);
                // è§¦å‘changeäº‹ä»¶ä»¥ä¿å­˜
                document.getElementById('systemPrompt').dispatchEvent(new Event('change'));

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                const successDiv = document.createElement('div');
                successDiv.className = 'success';
                successDiv.textContent = 'âœ… å·²åº”ç”¨ä¼˜åŒ–åçš„ System Promptï¼ä½ å¯ä»¥ç‚¹å‡»"å‘é€è¯·æ±‚"é‡æ–°æµ‹è¯•ã€‚';
                container.insertBefore(successDiv, container.firstChild);

                // 3ç§’åç§»é™¤æ¶ˆæ¯
                setTimeout(() => {
                    successDiv.remove();
                }, 3000);
            }
        }

        // å…³é—­ä¼˜åŒ–ç»“æœ
        function dismissOptimizedPrompt() {
            document.getElementById('optimizedPromptContainer').style.display = 'none';
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            // ä» localStorage æ¢å¤é…ç½®
            const savedSystemPrompt = localStorage.getItem('systemPrompt');
            const savedUserMessage = localStorage.getItem('userMessage');
            const savedApiKey = localStorage.getItem('apiKey');
            const savedModel = localStorage.getItem('model');
            const savedProvider = localStorage.getItem('apiProvider');

            if (savedSystemPrompt) document.getElementById('systemPrompt').value = savedSystemPrompt;
            if (savedUserMessage) document.getElementById('userMessage').value = savedUserMessage;
            if (savedApiKey) document.getElementById('apiKey').value = savedApiKey;
            if (savedModel) document.getElementById('model').value = savedModel;
            if (savedProvider) {
                document.getElementById('apiProvider').value = savedProvider;
                document.getElementById('apiProvider').dispatchEvent(new Event('change'));
            }
        });

        // è‡ªåŠ¨ä¿å­˜é…ç½®
        ['systemPrompt', 'userMessage', 'apiKey', 'model', 'apiProvider'].forEach(id => {
            const element = document.getElementById(id);
            element.addEventListener('change', function() {
                localStorage.setItem(id, this.value);
            });
        });
    </script>
</body>
</html>
