<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>系统提示词管理</title>
    <style>
        :root {
            --primary: #667eea;
            --primary-hover: #5568d3;
            --danger: #e74c3c;
            --border: #e9ecef;
            --bg: #f8f9fa;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f4f6f8;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }
        h1 { display: flex; justify-content: space-between; align-items: center; margin: 0 0 16px 0; }
        .auth { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; }
        .auth input { padding: 8px; border: 1px solid var(--border); border-radius: 4px; }
        .auth button { padding: 8px 14px; border: none; border-radius: 4px; cursor: pointer; background: var(--primary); color: #fff; }
        .auth .logout { background: #6c757d; }
        .alert { display: none; padding: 10px 14px; border-radius: 4px; margin-bottom: 12px; }
        .alert.show { display: block; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .tabs { display: flex; gap: 8px; margin: 12px 0; }
        .tab { padding: 10px 14px; border: 1px solid var(--border); background: #fff; cursor: pointer; border-radius: 6px; }
        .tab.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .card { background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .toolbar { display: flex; gap: 8px; align-items: center; }
        .btn { padding: 8px 12px; border: 1px solid var(--border); background: #fff; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: var(--primary); color: #fff; border-color: var(--primary); }
        .btn-danger { background: var(--danger); color: #fff; border-color: var(--danger); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; border-bottom: 1px solid var(--border); text-align: left; }
        th { background: #fafafa; }
        .loading { padding: 12px; text-align: center; color: #666; }
        .badge { padding: 2px 8px; border-radius: 4px; font-size: 12px; }
        .badge-on { background: #d4edda; color: #155724; }
        .badge-off { background: #f8d7da; color: #721c24; }
        .actions { display: flex; gap: 6px; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: #fff; border-radius: 8px; padding: 16px; width: 480px; max-width: calc(100% - 32px); box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .modal-content h3 { margin: 0 0 12px; }
        .form-group { margin-bottom: 12px; display: flex; flex-direction: column; gap: 6px; }
        .form-group input, .form-group textarea, .form-group select { padding: 8px; border: 1px solid var(--border); border-radius: 4px; }
        textarea { resize: vertical; min-height: 100px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <span>系统提示词管理</span>
            <span id="userInfo" style="font-size: 14px; color: #666;"></span>
        </h1>

        <div class="auth" id="authSection">
            <input type="email" id="emailInput" placeholder="邮箱" />
            <input type="password" id="passwordInput" placeholder="密码" />
            <button id="loginBtn">登录</button>
            <button id="logoutBtn" class="logout" style="display:none;">退出</button>
        </div>

        <div id="alert" class="alert"></div>

        <div class="tabs">
            <button class="tab active" data-tab="system">系统提示词</button>
            <button class="tab" data-tab="feature">功能提示词</button>
        </div>

        <!-- 系统提示词 -->
        <div id="systemTab" class="card">
            <div class="card-header">
                <div>系统提示词列表</div>
                <div class="toolbar">
                    <button class="btn" data-action="open-system-modal">+ 添加</button>
                    <button class="btn" data-action="refresh-system">刷新</button>
                </div>
            </div>
            <div id="systemLoading" class="loading">加载中...</div>
            <table id="systemTable" style="display:none;">
                <thead>
                    <tr>
                        <th>名称</th>
                        <th>functionKey</th>
                        <th>分类</th>
                        <th>状态</th>
                        <th>版本</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="systemTbody"></tbody>
            </table>
        </div>

        <!-- 功能提示词 -->
        <div id="featureTab" class="card" style="display:none;">
            <div class="card-header">
                <div>功能提示词列表</div>
                <div class="toolbar">
                    <select id="fpSystemPromptSelect" style="width:200px;">
                        <option value="">选择系统提示词</option>
                    </select>
                    <button class="btn" data-action="open-feature-modal">+ 添加</button>
                    <button class="btn" data-action="refresh-feature">刷新</button>
                </div>
            </div>
            <div id="featureLoading" class="loading">加载中...</div>
            <table id="featureTable" style="display:none;">
                <thead>
                    <tr>
                        <th>名称</th>
                        <th>功能类型</th>
                        <th>SystemPromptId</th>
                        <th>参考作品</th>
                        <th>参考链接</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="featureTbody"></tbody>
            </table>
        </div>
    </div>

    <!-- 系统提示词模态 -->
    <div id="systemModal" class="modal">
        <div class="modal-content">
            <h3 id="systemModalTitle">新增系统提示词</h3>
            <form id="systemForm">
                <input type="hidden" id="systemId" />
                <div class="form-group">
                    <label>名称 *</label>
                    <input type="text" id="systemName" required />
                </div>
                <div class="form-group">
                    <label>functionKey *</label>
                    <input type="text" id="systemFunctionKey" required />
                </div>
                <div class="form-group">
                    <label>分类</label>
                    <input type="text" id="systemCategory" />
                </div>
                <div class="form-group">
                    <label>描述</label>
                    <textarea id="systemDescription"></textarea>
                </div>
                <div class="form-group">
                    <label>提示词内容 *</label>
                    <textarea id="systemPrompt" required></textarea>
                </div>
                <div class="form-group">
                    <label>是否启用</label>
                    <select id="systemIsActive">
                        <option value="true">启用</option>
                        <option value="false">禁用</option>
                    </select>
                </div>
                <div class="form-actions" style="display:flex; gap:8px; justify-content:flex-end;">
                    <button type="button" class="btn" data-action="close-system-modal">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 功能提示词模态 -->
    <div id="featureModal" class="modal">
        <div class="modal-content">
            <h3 id="featureModalTitle">新增功能提示词</h3>
            <form id="featureForm">
                <input type="hidden" id="featureId" />
                <div class="form-group">
                    <label>系统提示词ID *</label>
                    <select id="featureSystemPromptId" required>
                        <option value="">请选择系统提示词</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>名称 *</label>
                    <input type="text" id="featureName" required />
                </div>
                <div class="form-group">
                    <label>功能类型 *</label>
                    <input type="text" id="featureFunctionType" required />
                </div>
                <div class="form-group">
                    <label>参考作品名称</label>
                    <input type="text" id="featureReferenceWorks" />
                </div>
                <div class="form-group">
                    <label>参考链接（逗号分隔）</label>
                    <input type="text" id="featureReferenceLinks" />
                </div>
                <div class="form-group">
                    <label>提示词内容 *</label>
                    <textarea id="featurePrompt" required></textarea>
                </div>
                <div class="form-actions" style="display:flex; gap:8px; justify-content:flex-end;">
                    <button type="button" class="btn" data-action="close-feature-modal">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let token = localStorage.getItem('token') || '';

        // DOM
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const userInfo = document.getElementById('userInfo');
        const alertBox = document.getElementById('alert');
        const tabs = document.querySelectorAll('.tab');
        const systemTab = document.getElementById('systemTab');
        const featureTab = document.getElementById('featureTab');
        const systemLoading = document.getElementById('systemLoading');
        const featureLoading = document.getElementById('featureLoading');
        const systemTable = document.getElementById('systemTable');
        const featureTable = document.getElementById('featureTable');
        const systemTbody = document.getElementById('systemTbody');
        const featureTbody = document.getElementById('featureTbody');
        const fpSystemPromptSelect = document.getElementById('fpSystemPromptSelect');

        const systemModal = document.getElementById('systemModal');
        const systemForm = document.getElementById('systemForm');
        const systemModalTitle = document.getElementById('systemModalTitle');
        const systemId = document.getElementById('systemId');
        const systemName = document.getElementById('systemName');
        const systemFunctionKey = document.getElementById('systemFunctionKey');
        const systemCategory = document.getElementById('systemCategory');
        const systemDescription = document.getElementById('systemDescription');
        const systemPrompt = document.getElementById('systemPrompt');
        const systemIsActive = document.getElementById('systemIsActive');

        const featureModal = document.getElementById('featureModal');
        const featureForm = document.getElementById('featureForm');
        const featureModalTitle = document.getElementById('featureModalTitle');
        const featureId = document.getElementById('featureId');
        const featureSystemPromptId = document.getElementById('featureSystemPromptId');
        const featureName = document.getElementById('featureName');
        const featureFunctionType = document.getElementById('featureFunctionType');
        const featureReferenceWorks = document.getElementById('featureReferenceWorks');
        const featureReferenceLinks = document.getElementById('featureReferenceLinks');
        const featurePrompt = document.getElementById('featurePrompt');

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            bindGlobalEvents();
            bindForms();
            checkAuth();
            if (token) {
                loadSystemPrompts();
                loadFeaturePrompts();
            }
        });

        function bindGlobalEvents() {
            // 登录/退出
            loginBtn.addEventListener('click', onLogin);
            logoutBtn.addEventListener('click', onLogout);

            // Tab 切换
            tabs.forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.tab)));

            // 选择系统提示词后自动加载功能提示词
            fpSystemPromptSelect.addEventListener('change', () => loadFeaturePrompts());

            // 工具栏事件委托
            document.body.addEventListener('click', (e) => {
                const action = e.target.getAttribute('data-action');
                if (!action) return;
                if (action === 'refresh-system') loadSystemPrompts();
                if (action === 'open-system-modal') openSystemModal();
                if (action === 'close-system-modal') closeSystemModal();
                if (action === 'refresh-feature') loadFeaturePrompts();
                if (action === 'open-feature-modal') openFeatureModal();
                if (action === 'close-feature-modal') closeFeatureModal();
            });

            // 列表操作委托
            systemTbody.addEventListener('click', (e) => {
                const action = e.target.getAttribute('data-action');
                const id = e.target.getAttribute('data-id');
                if (!action || !id) return;
                if (action === 'edit-system') editSystem(id);
                if (action === 'del-system') deleteSystem(id);
            });

            featureTbody.addEventListener('click', (e) => {
                const action = e.target.getAttribute('data-action');
                const id = e.target.getAttribute('data-id');
                if (!action || !id) return;
                if (action === 'edit-feature') editFeature(id);
                if (action === 'del-feature') deleteFeature(id);
            });
        }

        function bindForms() {
            systemForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveSystemPrompt();
            });
            featureForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveFeaturePrompt();
            });
        }

        // 认证
        async function onLogin() {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            if (!email || !password) return showAlert('请输入邮箱和密码', 'error');
            loginBtn.disabled = true;
            try {
                const res = await api('/api/auth/login', 'POST', { email, password });
                token = res.token;
                localStorage.setItem('token', token);
                userInfo.textContent = email;
                document.getElementById('authSection').style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                await loadSystemPrompts();
                await loadFeaturePrompts();
                showAlert('登录成功', 'success');
            } catch (err) {
                showAlert(err.message || '登录失败', 'error');
            } finally {
                loginBtn.disabled = false;
            }
        }

        function onLogout() {
            token = '';
            localStorage.removeItem('token');
            document.getElementById('authSection').style.display = 'flex';
            logoutBtn.style.display = 'none';
            userInfo.textContent = '';
            showAlert('已退出', 'success');
        }

        function checkAuth() {
            if (token) {
                document.getElementById('authSection').style.display = 'none';
                logoutBtn.style.display = 'inline-block';
            }
        }

        function switchTab(tab) {
            tabs.forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
            systemTab.style.display = tab === 'system' ? 'block' : 'none';
            featureTab.style.display = tab === 'feature' ? 'block' : 'none';
        }

        // API helper
        async function api(path, method = 'GET', body) {
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = `Bearer ${token}`;
            const res = await fetch(`${API_BASE}${path}`, {
                method,
                headers,
                body: body ? JSON.stringify(body) : undefined,
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data.message || `请求失败 ${res.status}`);
            return data;
        }

        // 系统提示词 CRUD
        async function loadSystemPrompts() {
            systemLoading.style.display = 'block';
            systemTable.style.display = 'none';
            try {
                const data = await api('/api/system-prompts');
                const list = data.data || [];
                systemTbody.innerHTML = list.map(renderSystemRow).join('');
                systemTable.style.display = 'table';
                // 填充下拉
                const options = ['<option value="">选择系统提示词</option>'].concat(
                    list.map(p => `<option value="${p.id}">${escape(p.name)} (${escape(p.functionKey)})</option>`)
                );
                fpSystemPromptSelect.innerHTML = options.join('');
                featureSystemPromptId.innerHTML = options.join('');
                // 默认选中第一个并加载功能提示词
                if (!fpSystemPromptSelect.value && list.length > 0) {
                    fpSystemPromptSelect.value = list[0].id;
                }
                if (fpSystemPromptSelect.value) {
                    await loadFeaturePrompts(fpSystemPromptSelect.value);
                }
            } catch (err) {
                systemTbody.innerHTML = `<tr><td colspan="6">${err.message}</td></tr>`;
            } finally {
                systemLoading.style.display = 'none';
            }
        }

        function renderSystemRow(item) {
            return `
                <tr>
                    <td>${escape(item.name)}</td>
                    <td>${escape(item.functionKey)}</td>
                    <td>${escape(item.category || '')}</td>
                    <td><span class="badge ${item.isActive ? 'badge-on' : 'badge-off'}">${item.isActive ? '启用' : '禁用'}</span></td>
                    <td>v${item.version || 1}</td>
                    <td class="actions">
                        <button class="btn" data-action="edit-system" data-id="${item.id}">编辑</button>
                        <button class="btn btn-danger" data-action="del-system" data-id="${item.id}">删除</button>
                    </td>
                </tr>
            `;
        }

        function openSystemModal(item) {
            systemModalTitle.textContent = item ? '编辑系统提示词' : '新增系统提示词';
            systemId.value = item?.id || '';
            systemName.value = item?.name || '';
            systemFunctionKey.value = item?.functionKey || '';
            systemCategory.value = item?.category || '';
            systemDescription.value = item?.description || '';
            systemPrompt.value = item?.prompt || '';
            systemIsActive.value = item?.isActive === false ? 'false' : 'true';
            systemModal.classList.add('show');
        }
        function closeSystemModal() { systemModal.classList.remove('show'); }

        async function editSystem(id) {
            try {
                const data = await api(`/api/system-prompts/${id}`);
                openSystemModal(data.data || data);
            } catch (err) {
                showAlert(err.message, 'error');
            }
        }
        async function deleteSystem(id) {
            if (!confirm('确认删除该系统提示词？')) return;
            try {
                await api(`/api/system-prompts/${id}`, 'DELETE');
                showAlert('删除成功', 'success');
                loadSystemPrompts();
            } catch (err) {
                showAlert(err.message, 'error');
            }
        }

        async function saveSystemPrompt() {
            const payload = {
                name: systemName.value.trim(),
                functionKey: systemFunctionKey.value.trim(),
                category: systemCategory.value.trim() || null,
                description: systemDescription.value.trim() || null,
                prompt: systemPrompt.value.trim(),
                isActive: systemIsActive.value === 'true',
            };
            if (!payload.name || !payload.functionKey || !payload.prompt) {
                return showAlert('名称、functionKey、提示词内容必填', 'error');
            }
            const idVal = systemId.value;
            try {
                if (idVal) {
                    await api(`/api/system-prompts/${idVal}`, 'PUT', payload);
                } else {
                    await api('/api/system-prompts', 'POST', payload);
                }
                closeSystemModal();
                showAlert('保存成功', 'success');
                loadSystemPrompts();
            } catch (err) {
                showAlert(err.message, 'error');
            }
        }

        // 功能提示词 CRUD
        async function loadFeaturePrompts(spId) {
            const systemPromptId = spId || fpSystemPromptSelect.value;
            featureLoading.style.display = 'block';
            featureTable.style.display = 'none';
            try {
                if (!systemPromptId) {
                    featureTbody.innerHTML = '<tr><td colspan="6">请选择系统提示词</td></tr>';
                    featureLoading.style.display = 'none';
                    return;
                }
                const data = await api(`/api/system-prompts/${systemPromptId}/feature-prompts`);
                const list = data.data || [];
                featureTbody.innerHTML = list.map(renderFeatureRow).join('');
                featureTable.style.display = 'table';
            } catch (err) {
                featureTbody.innerHTML = `<tr><td colspan="6">${err.message}</td></tr>`;
            } finally {
                featureLoading.style.display = 'none';
            }
        }

        function renderFeatureRow(item) {
            const links = Array.isArray(item.referenceLinks) ? item.referenceLinks : [];
            const linksHtml = links.length ? links.map(l => `<a href="${l}" target="_blank">${escape(l)}</a>`).join('<br>') : '';
            return `
                <tr>
                    <td>${escape(item.name)}</td>
                    <td>${escape(item.functionType || '')}</td>
                    <td>${escape(item.systemPromptId)}</td>
                    <td>${escape(item.referenceWorks || '')}</td>
                    <td>${linksHtml}</td>
                    <td class="actions">
                        <button class="btn" data-action="edit-feature" data-id="${item.id}">编辑</button>
                        <button class="btn btn-danger" data-action="del-feature" data-id="${item.id}">删除</button>
                    </td>
                </tr>
            `;
        }

        function openFeatureModal(item) {
            featureModalTitle.textContent = item ? '编辑功能提示词' : '新增功能提示词';
            featureId.value = item?.id || '';
            featureSystemPromptId.value = item?.systemPromptId || fpSystemPromptSelect.value || '';
            featureName.value = item?.name || '';
            featureFunctionType.value = item?.functionType || '';
            featureReferenceWorks.value = item?.referenceWorks || '';
            featureReferenceLinks.value = Array.isArray(item?.referenceLinks) ? item.referenceLinks.join(',') : '';
            featurePrompt.value = item?.prompt || '';
            featureModal.classList.add('show');
        }
        function closeFeatureModal() { featureModal.classList.remove('show'); }

        async function editFeature(id) {
            try {
                const data = await api(`/api/system-prompts/feature-prompts/${id}`);
                openFeatureModal(data.data || data);
            } catch (err) {
                showAlert(err.message, 'error');
            }
        }
        async function deleteFeature(id) {
            if (!confirm('确认删除该功能提示词？')) return;
            try {
                await api(`/api/system-prompts/feature-prompts/${id}`, 'DELETE');
                showAlert('删除成功', 'success');
                loadFeaturePrompts();
            } catch (err) {
                showAlert(err.message, 'error');
            }
        }

        async function saveFeaturePrompt() {
            const payload = {
                systemPromptId: featureSystemPromptId.value.trim(),
                name: featureName.value.trim(),
                functionType: featureFunctionType.value.trim(),
                referenceWorks: featureReferenceWorks.value.trim() || null,
                referenceLinks: featureReferenceLinks.value.trim()
                    ? featureReferenceLinks.value.split(',').map(s => s.trim()).filter(Boolean)
                    : null,
                prompt: featurePrompt.value.trim(),
            };
            if (!payload.systemPromptId || !payload.name || !payload.functionType || !payload.prompt) {
                return showAlert('系统提示词ID、名称、功能类型、提示词内容必填', 'error');
            }
            const idVal = featureId.value;
            try {
                if (idVal) {
                    await api(`/api/system-prompts/feature-prompts/${idVal}`, 'PUT', payload);
                } else {
                    await api(`/api/system-prompts/${payload.systemPromptId}/feature-prompts`, 'POST', payload);
                }
                closeFeatureModal();
                fpSystemPromptId.value = payload.systemPromptId;
                showAlert('保存成功', 'success');
                loadFeaturePrompts(payload.systemPromptId);
            } catch (err) {
                showAlert(err.message, 'error');
            }
        }

        // 工具
        function escape(str) {
            if (str === undefined || str === null) return '';
            return String(str).replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
        }

        function showAlert(msg, type = 'success') {
            alertBox.textContent = msg;
            alertBox.className = `alert alert-${type} show`;
            setTimeout(() => alertBox.classList.remove('show'), 4000);
        }
    </script>
</body>
</html>

